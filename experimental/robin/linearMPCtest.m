N = 20;
nx = 8;
nu = 3;

A = [0.76272   0.11488   0.00248   0.00002   0.45961   0.01981   0.00025   0.00000 ;
  0.11488   0.76520   0.11490   0.00248   0.01981   0.45987   0.01981   0.00025 ;
  0.00248   0.11490   0.76520   0.11488   0.00025   0.01981   0.45987   0.01981 ;
  0.00002   0.00248   0.11488   0.76272   0.00000   0.00025   0.01981   0.45961 ;
 -0.89941   0.42024   0.01931   0.00025   0.76272   0.11488   0.00248   0.00002 ;
  0.42024  -0.88010   0.42049   0.01931   0.11488   0.76520   0.11490   0.00248 ;
  0.01931   0.42049  -0.88010   0.42024   0.00248   0.11490   0.76520   0.11488 ;
  0.00025   0.01931   0.42024  -0.89941   0.00002   0.00248   0.11488   0.76272 ];

B = [0.11990   0.00252   0.00002 ;
  0.00252   0.11992   0.00252 ;
  0.00002   0.00252   0.11992 ;
  0.00000   0.00002   0.00252 ;
  0.45961   0.01981   0.00025 ;
  0.01981   0.45987   0.01981 ;
  0.00025   0.01981   0.45987 ;
  0.00000   0.00025   0.01981 ];

b = [0.10000 ;
  0.10000 ;
  0.10000 ;
  0.10000 ;
  0.10000 ;
  0.10000 ;
  0.10000 ;
  0.10000];

x0 = [  2.50000 ;
  2.50000 ;
  0.00000 ;
  0.00000 ;
  0.00000 ;
  0.00000 ;
  0.00000 ;
  0.00000 ];

% Cost function
Q = eye(nx);
R = 2*eye(nu);
q = 0.1*ones(nx,1);
r = 0.2*ones(nu,1);
H = blkdiag(kron(eye(N),blkdiag(Q,R)),Q);
f = [repmat([q;r],N,1);q];

G = [-eye(nx),zeros(nx,N*(nx+nu))];
g = [x0;repmat(b,N,1)];
for i=0:N-1
    G = [G;zeros(nx,i*(nx+nu)),A,B,-eye(nx),zeros(nx,(N-i-1)*(nx+nu))];
end

lb = [repmat([-4*ones(nx,1);-0.5*ones(nu,1)],N,1);-4*ones(nx,1)];
ub = -lb;

w = quadprog(H,f,[],[],G,-g,lb,ub);

XU = reshape([w;zeros(nu,1)],nx+nu,N+1).'
